---
title: "Sodium GCS Mediation Mortality"
author: Miguel Ángel Armengol de la Hoz
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mediation)
library(mgcv)
library(plotly)
library(voxel)
library(htmlwidgets)
library(readr)
library(stringi)
'%!in%' <- function(x,y)!('%in%'(x,y))
extract_mediation_summary <- function (x) { 

  clp <- 100 * x$conf.level
  isLinear.y <- ((class(x$model.y)[1] %in% c("lm", "rq")) || 
                   (inherits(x$model.y, "glm") && x$model.y$family$family == 
                      "gaussian" && x$model.y$family$link == "identity") || 
                   (inherits(x$model.y, "survreg") && x$model.y$dist == 
                      "gaussian"))

  printone <- !x$INT && isLinear.y

  if (printone) {

    smat <- c(x$d1, x$d1.ci, x$d1.p)
    smat <- rbind(smat, c(x$z0, x$z0.ci, x$z0.p))
    smat <- rbind(smat, c(x$tau.coef, x$tau.ci, x$tau.p))
    smat <- rbind(smat, c(x$n0, x$n0.ci, x$n0.p))

    rownames(smat) <- c("ACME", "ADE", "Total Effect", "Prop. Mediated")

  } else {
    smat <- c(x$d0, x$d0.ci, x$d0.p)
    smat <- rbind(smat, c(x$d1, x$d1.ci, x$d1.p))
    smat <- rbind(smat, c(x$z0, x$z0.ci, x$z0.p))
    smat <- rbind(smat, c(x$z1, x$z1.ci, x$z1.p))
    smat <- rbind(smat, c(x$tau.coef, x$tau.ci, x$tau.p))
    smat <- rbind(smat, c(x$n0, x$n0.ci, x$n0.p))
    smat <- rbind(smat, c(x$n1, x$n1.ci, x$n1.p))
    smat <- rbind(smat, c(x$d.avg, x$d.avg.ci, x$d.avg.p))
    smat <- rbind(smat, c(x$z.avg, x$z.avg.ci, x$z.avg.p))
    smat <- rbind(smat, c(x$n.avg, x$n.avg.ci, x$n.avg.p))

    rownames(smat) <- c("ACME (control)", "ACME (treated)", 
                        "ADE (control)", "ADE (treated)", "Total Effect", 
                        "Prop. Mediated (control)", "Prop. Mediated (treated)", 
                        "ACME (average)", "ADE (average)", "Prop. Mediated (average)")

  }

  colnames(smat) <- c("Estimate", paste(clp, "% CI Lower", sep = ""), 
                      paste(clp, "% CI Upper", sep = ""), "p-value")
  smat

}
```

# Severity Prediction from apache

```{r}
data_for_apache_pred<-inner_join(allapachevars,basic_demographics%>%select(patientunitstayid,hosp_mortality))

# -1 means missing on the following variables
# data_for_apache_pred$eyes[data_for_apache_pred$eyes==-1]<-NA
# data_for_apache_pred$motor[data_for_apache_pred$motor==-1]<-NA
# data_for_apache_pred$verbal[data_for_apache_pred$verbal==-1]<-NA
# data_for_apache_pred$meds[data_for_apache_pred$meds==-1]<-NA
# data_for_apache_pred$urine[data_for_apache_pred$urine==-1]<-NA
# data_for_apache_pred$wbc[data_for_apache_pred$wbc==-1]<-NA
# data_for_apache_pred$temperature[data_for_apache_pred$temperature==-1]<-NA
# data_for_apache_pred$respiratoryrate[data_for_apache_pred$respiratoryrate==-1]<-NA
# data_for_apache_pred$heartrate[data_for_apache_pred$heartrate==-1]<-NA
# data_for_apache_pred$meanbp[data_for_apache_pred$meanbp==-1]<-NA
# data_for_apache_pred$ph[data_for_apache_pred$ph==-1]<-NA
# data_for_apache_pred$hematocrit[data_for_apache_pred$hematocrit==-1]<-NA
# data_for_apache_pred$creatinine[data_for_apache_pred$creatinine==-1]<-NA
# data_for_apache_pred$albumin[data_for_apache_pred$albumin==-1]<-NA
# data_for_apache_pred$pao2[data_for_apache_pred$pao2==-1]<-NA
# data_for_apache_pred$pco2[data_for_apache_pred$pco2==-1]<-NA
# data_for_apache_pred$bun[data_for_apache_pred$bun==-1]<-NA
# data_for_apache_pred$glucose[data_for_apache_pred$glucose==-1]<-NA
# data_for_apache_pred$bilirubin[data_for_apache_pred$bilirubin==-1]<-NA
# data_for_apache_pred$fio2[data_for_apache_pred$fio2==-1]<-NA
# data_for_apache_pred$admitsource[data_for_apache_pred$admitsource==-1]<-NA
# data_for_apache_pred$ejectfx[data_for_apache_pred$ejectfx==-1]<-NA
# data_for_apache_pred$dischargelocation[data_for_apache_pred$dischargelocation==-1]<-NA
# data_for_apache_pred$amilocation[data_for_apache_pred$amilocation==-1]<-NA
# data_for_apache_pred$day1pao2[data_for_apache_pred$day1pao2==-1]<-NA
# data_for_apache_pred$day1fio2[data_for_apache_pred$day1fio2==-1]<-NA
# data_for_apache_pred$day1meds[data_for_apache_pred$day1meds==-1]<-NA
# data_for_apache_pred$day1verbal[data_for_apache_pred$day1verbal==-1]<-NA
# data_for_apache_pred$day1motor[data_for_apache_pred$day1motor==-1]<-NA
# data_for_apache_pred$day1eyes[data_for_apache_pred$day1eyes==-1]<-NA


# the following variables are factors
data_for_apache_pred$intubated<-as.factor(data_for_apache_pred$intubated)
data_for_apache_pred$vent<-as.factor(data_for_apache_pred$vent)
data_for_apache_pred$dialysis<-as.factor(data_for_apache_pred$dialysis)
data_for_apache_pred$meds<-as.factor(data_for_apache_pred$meds)
data_for_apache_pred$thrombolytics<-as.factor(data_for_apache_pred$thrombolytics)
data_for_apache_pred$diedinhospital<-as.factor(data_for_apache_pred$diedinhospital)
data_for_apache_pred$aids<-as.factor(data_for_apache_pred$aids)
data_for_apache_pred$hepaticfailure<-as.factor(data_for_apache_pred$hepaticfailure)
data_for_apache_pred$lymphoma<-as.factor(data_for_apache_pred$lymphoma)
data_for_apache_pred$metastaticcancer<-as.factor(data_for_apache_pred$metastaticcancer)
data_for_apache_pred$leukemia<-as.factor(data_for_apache_pred$leukemia)
data_for_apache_pred$immunosuppression<-as.factor(data_for_apache_pred$immunosuppression)
data_for_apache_pred$cirrhosis<-as.factor(data_for_apache_pred$cirrhosis)
data_for_apache_pred$electivesurgery<-as.factor(data_for_apache_pred$electivesurgery)
data_for_apache_pred$activetx<-as.factor(data_for_apache_pred$activetx)
data_for_apache_pred$readmit<-as.factor(data_for_apache_pred$readmit)
data_for_apache_pred$ima<-as.factor(data_for_apache_pred$ima)
data_for_apache_pred$midur<-as.factor(data_for_apache_pred$midur)
data_for_apache_pred$ventday1<-as.factor(data_for_apache_pred$ventday1)
data_for_apache_pred$oobventday1<-as.factor(data_for_apache_pred$oobventday1)
data_for_apache_pred$oobintubday1<-as.factor(data_for_apache_pred$oobintubday1)
data_for_apache_pred$diabetes<-as.factor(data_for_apache_pred$diabetes)
data_for_apache_pred$day1meds<-as.factor(data_for_apache_pred$day1meds)
data_for_apache_pred$hosp_mortality<-as.factor(data_for_apache_pred$hosp_mortality)


# the following variables always had the same values for all paitents:
data_for_apache_pred$patientunitstayid<-NULL
data_for_apache_pred$sicuday<-NULL
data_for_apache_pred$saps3day1<-NULL
data_for_apache_pred$saps3today<-NULL
data_for_apache_pred$saps3yesterday<-NULL
data_for_apache_pred$teachtype<-NULL
data_for_apache_pred$region<-NULL
data_for_apache_pred$managementsystem<-NULL
data_for_apache_pred$var03hspxlos<-NULL

# these variables' coefficients appear as NA
data_for_apache_pred$ventday1<-NULL                  
data_for_apache_pred$day1meds<-NULL
data_for_apache_pred$day1verbal<-NULL
data_for_apache_pred$day1motor<-NULL
data_for_apache_pred$day1eyes<-NULL
data_for_apache_pred$day1pao2<-NULL
data_for_apache_pred$day1fio2<-NULL



severity_variables<-glm(hosp_mortality ~ .
                   , data_for_apache_pred
           ,family = 'binomial')

summary(severity_variables)
```


# Mediation package

 - *ACME:*  Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
 - *ADE:*  Average direct effects. It describes the direct effect of the IV on the Outcome.
 - *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
 - *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. It’s calculated by dividing the ACME through the total effect.

# Binary Baseline GCS analysis

## Mediation analysis: Baseline sodium Continous

### The total effect

```{r}
fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium1 +                       
apache_iv+age+gender+ethnicity+unittype+ charlson_liver1 +charlson_chf1+mechvent_day01
# apache related variables
                   , selected_df
,family = 'binomial')
summary(fit_totaleffect)

OR_table<-as.data.frame(round(exp(cbind(OR=coef(fit_totaleffect), confint.default(fit_totaleffect))),2))

OR_table

```

### The effect of the baseline sodium onto the mediator

```{r}
fit_mediator<-gam( normal_gcs ~ s(sodium1) +                       
apache_iv+age+gender+ethnicity+unittype+ charlson_liver1 +charlson_chf1+mechvent_day01
# apache related variables
 
                   ,data =  selected_df)


summary(fit_mediator)

```

### The effect of the mediator on the the dependent variable

```{r}
fit_dv<-glm(as.factor(hosp_mortality) ~ normal_gcs + sodium_cat +apache_iv+age+gender+ethnicity+unittype+ charlson_liver1 +charlson_chf1+mechvent_day01
                   + mechvent_day01 
                   , sodium_cat_1_df
           ,family = 'binomial')
summary(fit_dv)

OR_table<-as.data.frame(round(exp(cbind(OR=coef(fit_dv), confint.default(fit_dv))),2))

OR_table
```

### Causal Mediation Analysis

```{r}
#treat is the independend variable
mediation_results_cat1 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 20)

mediation_results_cat1_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat1))
mediation_results_cat1_sum

mediation_results_cat1_sum<-mediation_results_cat1_sum[grepl("treated|Total Effect", rownames(mediation_results_cat1_sum)), ]
```

# Ploting results

## Appending results

 - *ACME:*  Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
 - *ADE:*  Average direct effects. It describes the direct effect of the IV on the Outcome.
 - *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
 - *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. It’s calculated by dividing the ACME through the total effect.

```{r}
# we want to be able to know which dataset our results are coming from
mediation_results_cat1_sum$cat<-1
mediation_results_cat1_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat1_sum),'(treated)',"" )
mediation_results_cat2_sum$cat<-2
mediation_results_cat2_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat2_sum),'(treated)',"" )
mediation_results_cat3_sum$cat<-3
mediation_results_cat3_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat3_sum),'(treated)',"" )
mediation_results_cat4_sum$cat<-4
mediation_results_cat4_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat4_sum),'(treated)',"" )
mediation_results_cat6_sum$cat<-6
mediation_results_cat6_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat6_sum),'(treated)',"" )
mediation_results_cat7_sum$cat<-7
mediation_results_cat7_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat7_sum),'(treated)',"" )
mediation_results_cat8_sum$cat<-8
mediation_results_cat8_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat8_sum),'(treated)',"" )


mediation_results_all<-rbind(
 mediation_results_cat1_sum
,mediation_results_cat2_sum
,mediation_results_cat3_sum
,mediation_results_cat4_sum
,mediation_results_cat6_sum
,mediation_results_cat7_sum
,mediation_results_cat8_sum
)
rownames(mediation_results_all)<-NULL
```

## Final Plot

```{r}
mediation_results_filtered<-mediation_results_all%>% filter(results %in% c('ACME '))

ggplot(data=mediation_results_filtered,aes(x=cat,y=Estimate,colour=results,fill=results))+
    geom_point()+
    geom_line()+
    geom_errorbar(data=mediation_results_filtered
                  ,aes(x=cat,ymin=`95% CI Lower`,ymax=`95% CI Upper`,fill=results)
                  ,alpha=0.3
                  ,inherit.aes=FALSE
                  ,width=0.2)+
    xlab('Baseline Sodium Category')+
    ylab('Estimate')+
    #scale_color_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #scale_fill_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #labs(colour='sex', fill='sex') +
    theme_minimal()+
  ggtitle('ACME\nAverage Causal Mediation Effects\nIndirect effect of Sodium on mortality that goes through the mediator (GCS)')+
  scale_x_continuous(breaks = c(1,2,3,4,6,7,8))
```


