
# SubAnalysis 1, Sedation Score

## SubAnalysis 1A: Sedated by Med SubAnalysis

### Mediation package

#### Baseline sodium_cat_1

##### Mediation Analysis

```{r}
total_effect_sedated<-NULL
sodium_cat_1_sedated_df$sodium_cat<-as.factor(sodium_cat_1_sedated_df$sodium_cat)
sodium_cat_1_sedated_df$sodium_cat<-relevel(sodium_cat_1_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+ AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_1_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 1,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))



fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_1_sedated_df)

fit_dv<-glm(as.factor(hosp_mortality)~gcs_baseline+sodium_cat+ AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_1_sedated_df
           ,family = binomial("probit"))

summary(fit_dv)

#treat is the independend variable

mediation_results_cat1_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 1,
                                  sims = 1000)
mediation_results_cat1_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat1_sedated))
mediation_results_cat1_sedated_sum<-mediation_results_cat1_sedated_sum[c(5,8,9,10),]

#replace effect of treated group with average effect
#mediation_results_cat1_sedated_sum<-mediation_results_cat1_sedated_sum[grepl("treated|Total Effect", rownames(mediation_results_cat1_sedated_sum)), ]#

mediation_results_cat1_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated1 <- medsens(mediation_results_cat1_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
log_info()
```

#### Baseline sodium_cat_2

##### Mediation Analysis

```{r}
sodium_cat_2_sedated_df$sodium_cat<-as.factor(sodium_cat_2_sedated_df$sodium_cat)
sodium_cat_2_sedated_df$sodium_cat<-relevel(sodium_cat_2_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_2_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 2,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))



fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_2_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_2_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat2_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 2,
                                  sims = 1000)
mediation_results_cat2_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat2_sedated))
mediation_results_cat2_sedated_sum<-mediation_results_cat2_sedated_sum[c(5,8,9,10),]

mediation_results_cat2_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated2 <- medsens(mediation_results_cat2_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
log_info()
```

#### Baseline sodium_cat_3

##### Mediation Analysis

```{r}
sodium_cat_3_sedated_df$sodium_cat<-as.factor(sodium_cat_3_sedated_df$sodium_cat)
sodium_cat_3_sedated_df$sodium_cat<-relevel(sodium_cat_3_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+age+AP_grp+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+respiratoryrate+MAP

                   , sodium_cat_3_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 3,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))

fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_3_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_3_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat3_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 3,
                                  sims = 1000)
mediation_results_cat3_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat3_sedated))
mediation_results_cat3_sedated_sum<-mediation_results_cat3_sedated_sum[c(5,8,9,10),]

mediation_results_cat3_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated3 <- medsens(mediation_results_cat3_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_4

##### Mediation Analysis

```{r}
sodium_cat_4_sedated_df$sodium_cat<-as.factor(sodium_cat_4_sedated_df$sodium_cat)
sodium_cat_4_sedated_df$sodium_cat<-relevel(sodium_cat_4_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_4_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 4,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_4_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_4_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat4_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 4,
                                  sims = 1000)
mediation_results_cat4_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat4_sedated))
mediation_results_cat4_sedated_sum<-mediation_results_cat4_sedated_sum[c(5,8,9,10),]
mediation_results_cat4_sedated_sum

```

##### Sensitivity Analysis

```{r}
sens.out_sedated4 <- medsens(mediation_results_cat4_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```
#### Baseline sodium_cat_6

##### Mediation Analysis

```{r}
sodium_cat_6_sedated_df$sodium_cat<-as.factor(sodium_cat_6_sedated_df$sodium_cat)
sodium_cat_6_sedated_df$sodium_cat<-relevel(sodium_cat_6_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_6_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 6,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_6_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_6_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat6_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 6,
                                  sims = 1000)
mediation_results_cat6_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat6_sedated))
mediation_results_cat6_sedated_sum<-mediation_results_cat6_sedated_sum[c(5,8,9,10),]
mediation_results_cat6_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated6 <- medsens(mediation_results_cat6_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_7

##### Mediation Analysis

```{r}
sodium_cat_7_sedated_df$sodium_cat<-as.factor(sodium_cat_7_sedated_df$sodium_cat)
sodium_cat_7_sedated_df$sodium_cat<-relevel(sodium_cat_7_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_7_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 7,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_7_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_7_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat7_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 7,
                                  sims = 1000)
mediation_results_cat7_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat7_sedated))
mediation_results_cat7_sedated_sum<-mediation_results_cat7_sedated_sum[c(5,8,9,10),]
mediation_results_cat7_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated7 <- medsens(mediation_results_cat7_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_8

##### Mediation Analysis

```{r}
sodium_cat_8_sedated_df$sodium_cat<-as.factor(sodium_cat_8_sedated_df$sodium_cat)
sodium_cat_8_sedated_df$sodium_cat<-relevel(sodium_cat_8_sedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_8_sedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_sedated<-rbind(total_effect_sedated,data.frame(cat = 8,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_8_sedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_8_sedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat8_sedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 8,
                                  sims = 1000)
mediation_results_cat8_sedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat8_sedated))
mediation_results_cat8_sedated_sum<-mediation_results_cat8_sedated_sum[c(5,8,9,10),]
mediation_results_cat8_sedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_sedated8 <- medsens(mediation_results_cat8_sedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

## SubAnalysis 1B: Not Sedated by Med SubAnalysis

### Mediation package

#### Baseline sodium_cat_1

##### Mediation Analysis

```{r}
total_effect_notsedated<-NULL
sodium_cat_1_notsedated_df$sodium_cat<-as.factor(sodium_cat_1_notsedated_df$sodium_cat)
sodium_cat_1_notsedated_df$sodium_cat<-relevel(sodium_cat_1_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+ AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_1_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 1,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))



fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_1_notsedated_df)

fit_dv<-glm(as.factor(hosp_mortality)~gcs_baseline+sodium_cat+ AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_1_notsedated_df
           ,family = binomial("probit"))

summary(fit_dv)

#treat is the independend variable

mediation_results_cat1_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 1,
                                  sims = 1000)
mediation_results_cat1_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat1_notsedated))
mediation_results_cat1_notsedated_sum<-mediation_results_cat1_notsedated_sum[c(5,8,9,10),]

#replace effect of treated group with average effect
#mediation_results_cat1_notsedated_sum<-mediation_results_cat1_notsedated_sum[grepl("treated|Total Effect", rownames(mediation_results_cat1_notsedated_sum)), ]#

mediation_results_cat1_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated1 <- medsens(mediation_results_cat1_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_2

##### Mediation Analysis

```{r}
sodium_cat_2_notsedated_df$sodium_cat<-as.factor(sodium_cat_2_notsedated_df$sodium_cat)
sodium_cat_2_notsedated_df$sodium_cat<-relevel(sodium_cat_2_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_2_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 2,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))



fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_2_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_2_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat2_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 2,
                                  sims = 1000)
mediation_results_cat2_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat2_notsedated))
mediation_results_cat2_notsedated_sum<-mediation_results_cat2_notsedated_sum[c(5,8,9,10),]

mediation_results_cat2_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated2 <- medsens(mediation_results_cat2_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_3

##### Mediation Analysis

```{r}
sodium_cat_3_notsedated_df$sodium_cat<-as.factor(sodium_cat_3_notsedated_df$sodium_cat)
sodium_cat_3_notsedated_df$sodium_cat<-relevel(sodium_cat_3_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+age+AP_grp+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+respiratoryrate+MAP

                   , sodium_cat_3_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 3,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))

fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_3_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_3_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat3_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 3,
                                  sims = 1000)
mediation_results_cat3_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat3_notsedated))
mediation_results_cat3_notsedated_sum<-mediation_results_cat3_notsedated_sum[c(5,8,9,10),]

mediation_results_cat3_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated3 <- medsens(mediation_results_cat3_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_4

##### Mediation Analysis

```{r}
sodium_cat_4_notsedated_df$sodium_cat<-as.factor(sodium_cat_4_notsedated_df$sodium_cat)
sodium_cat_4_notsedated_df$sodium_cat<-relevel(sodium_cat_4_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_4_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 4,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_4_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_4_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat4_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 4,
                                  sims = 1000)
mediation_results_cat4_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat4_notsedated))
mediation_results_cat4_notsedated_sum<-mediation_results_cat4_notsedated_sum[c(5,8,9,10),]
mediation_results_cat4_notsedated_sum

```

##### Sensitivity Analysis

```{r}
sens.out_notsedated4 <- medsens(mediation_results_cat4_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```
#### Baseline sodium_cat_6

##### Mediation Analysis

```{r}
sodium_cat_6_notsedated_df$sodium_cat<-as.factor(sodium_cat_6_notsedated_df$sodium_cat)
sodium_cat_6_notsedated_df$sodium_cat<-relevel(sodium_cat_6_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_6_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 6,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_6_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_6_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat6_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 6,
                                  sims = 1000)
mediation_results_cat6_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat6_notsedated))
mediation_results_cat6_notsedated_sum<-mediation_results_cat6_notsedated_sum[c(5,8,9,10),]
mediation_results_cat6_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated6 <- medsens(mediation_results_cat6_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_7

##### Mediation Analysis

```{r}
sodium_cat_7_notsedated_df$sodium_cat<-as.factor(sodium_cat_7_notsedated_df$sodium_cat)
sodium_cat_7_notsedated_df$sodium_cat<-relevel(sodium_cat_7_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat+AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1

                   , sodium_cat_7_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 7,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_7_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_7_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat7_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 7,
                                  sims = 1000)
mediation_results_cat7_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat7_notsedated))
mediation_results_cat7_notsedated_sum<-mediation_results_cat7_notsedated_sum[c(5,8,9,10),]
mediation_results_cat7_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated7 <- medsens(mediation_results_cat7_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

#### Baseline sodium_cat_8

##### Mediation Analysis

```{r}
sodium_cat_8_notsedated_df$sodium_cat<-as.factor(sodium_cat_8_notsedated_df$sodium_cat)
sodium_cat_8_notsedated_df$sodium_cat<-relevel(sodium_cat_8_notsedated_df$sodium_cat,ref = "5")
fit_totaleffect<-glm(as.factor(hosp_mortality)~sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_8_notsedated_df
,family = binomial)
summ<-summary(fit_totaleffect)
total_effect_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 8,estimated = summ$coefficients[2],se = summ$coefficients[2+length(summ$coefficients)/4],p = summ$coefficients[2+3*length(summ$coefficients)/4]))


fit_mediator<-lm(gcs_baseline ~ sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1,
data =  sodium_cat_8_notsedated_df)
fit_dv<-glm(as.factor(hosp_mortality) ~gcs_baseline+sodium_cat + AP_grp + ethnicity + gender + age + MAP + temperature + heartrate + respiratoryrate + mechvent_day01 + day1fio2 + day1pao2 + pco2 + ph + urine + creatinine + albumin + bilirubin + wbc + cirrhosis + aids + leukemia + immunosuppression + charlson_chf1 + charlson_liver1
                   , sodium_cat_8_notsedated_df
           ,family = binomial("probit"))
summary(fit_dv)
#treat is the independend variable
mediation_results_cat8_notsedated <- mediate(fit_mediator, fit_dv, 
                                  treat="sodium_cat", mediator="gcs_baseline",control.value = 5,treat.value = 8,
                                  sims = 1000)
mediation_results_cat8_notsedated_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat8_notsedated))
mediation_results_cat8_notsedated_sum<-mediation_results_cat8_notsedated_sum[c(5,8,9,10),]
mediation_results_cat8_notsedated_sum
```

##### Sensitivity Analysis

```{r}
sens.out_notsedated8 <- medsens(mediation_results_cat8_notsedated, rho.by = 0.1, effect.type = "indirect", sims = 200)
```

# Figure 3B: NOT SEDATED BY MED Subanalysis

## Appending results for plot

-   *ACME:* Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
-   *ADE:* Average direct effects. It describes the direct effect of the IV on the Outcome.
-   *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
-   *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. It's calculated by dividing the ACME through the total effect.

```{r}
# we want to be able to know which dataset our results are coming from
mediation_results_cat1_notsedated_sum$cat<-1
mediation_results_cat1_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat1_notsedated_sum),'(treated)',"" )
mediation_results_cat2_notsedated_sum$cat<-2
mediation_results_cat2_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat2_notsedated_sum),'(treated)',"" )
mediation_results_cat3_notsedated_sum$cat<-3
mediation_results_cat3_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat3_notsedated_sum),'(treated)',"" )
mediation_results_cat4_notsedated_sum$cat<-4
mediation_results_cat4_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat4_notsedated_sum),'(treated)',"" )
mediation_results_cat6_notsedated_sum$cat<-6
mediation_results_cat6_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat6_notsedated_sum),'(treated)',"" )
mediation_results_cat7_notsedated_sum$cat<-7
mediation_results_cat7_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat7_notsedated_sum),'(treated)',"" )
mediation_results_cat8_notsedated_sum$cat<-8
mediation_results_cat8_notsedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat8_notsedated_sum),'(treated)',"" )
mediation_results_all_notsedated<-rbind(
 mediation_results_cat1_notsedated_sum
,mediation_results_cat2_notsedated_sum
,mediation_results_cat3_notsedated_sum
,mediation_results_cat4_notsedated_sum
,mediation_results_cat6_notsedated_sum
,mediation_results_cat7_notsedated_sum
,mediation_results_cat8_notsedated_sum
)

rownames(mediation_results_all_notsedated)<-NULL

#add total effect (Odds ratio) to the table

total_effect_forplot_notsedated<-rbind(total_effect_notsedated,data.frame(cat = 5,estimated = 0,se = 0,p = NA))

total_effect_forplot_notsedated<-total_effect_forplot_notsedated%>%
  mutate(lb = estimated -1.96*se, ub = estimated + 1.96*se)%>%
  mutate(or = exp(estimated),or.lb = exp(lb),or.ub = exp(ub))

total_effect_forplot_notsedated_copy<-total_effect_forplot_notsedated%>%transmute(Estimate = or, '95% CI Upper' = or.ub,'95% CI Lower' = or.lb,cat = cat,'p-value' = p,results = "Total Effect (OR)")

results_notsedated<-rbind(mediation_results_all_notsedated,total_effect_forplot_notsedated_copy)
```


## Final subfigure: Prop. Mediated + Total Effect

```{r }
mediation_results_notsedated_propmediated<-mediation_results_all_notsedated%>%
  filter(results %in% c("Prop. Mediated (average)") ) %>%
  dplyr::select(Estimate,cat,results)

mediation_results_notsedated_propmediated<-rbind(mediation_results_notsedated_propmediated,
                                      data.frame(Estimate = 0, cat = 5, results = "Prop. Mediated (average)"))

spline_x <-spline(total_effect_forplot_notsedated$cat, (total_effect_forplot_notsedated$or - 1) * 100, n = 1000)$x
spline_hi <-spline(total_effect_forplot_notsedated$cat, (total_effect_forplot_notsedated$or.ub - 1) * 100, n = 1000)$y
spline_lo <-spline(total_effect_forplot_notsedated$cat, (total_effect_forplot_notsedated$or.lb - 1) * 100, n = 1000)$y

foo_ribbon <-data.frame(spline_x, spline_hi, spline_lo)

fig3b <- ggplot(data = mediation_results_notsedated_propmediated, aes(x = cat, y = Estimate * 100)) +
  geom_bar(stat = 'identity', fill = "#27ae60") +
  xlab('Baseline Sodium Category') +
  ylab('%') +
  geom_text(data = mediation_results_notsedated_propmediated, aes(label = paste(round(Estimate * 100, 2), '%')), colour = "#2c3e50", vjust = 1.5) +
  scale_y_continuous(breaks = c(0, 50, 100)) +
  theme(legend.position = "bottom", plot.title.position = "plot", plot.caption.position =  "plot") +
  theme_minimal() +
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8),
                     labels = c("<120", "120- <125", "125- <130", "130- <135", "135- <140\n(Reference)", "140- <145", "145- <150", ">150")) +
  geom_point(data = total_effect_forplot_notsedated, aes(x = cat, y = (or - 1) * 100), colour = "#34495e") +
  geom_smooth(data = total_effect_forplot_notsedated, aes(x = cat, y = (or - 1) * 100), method = "loess", span = 0.5, se = FALSE, colour = "#34495e") +
  geom_ribbon(data = foo_ribbon, aes(x = spline_x, y = NULL, ymin = spline_lo, ymax = spline_hi),
              alpha = 0.4, inherit.aes = FALSE, width = 0.2, fill = '#2980b9') +
  scale_y_continuous(position = "right", 
                     limits = c(-90, 245),
                     name = "Proportion of mortality mediated by GCS score",
                     sec.axis = sec_axis(~(. / 100) + 1, name = "Odds ratio (95%CI) of hospital mortality")) +
  labs(caption = "")
```

# Figure 3C: SEDATED BY MED Subanalysis

## Appending results for plot

-   *ACME:* Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
-   *ADE:* Average direct effects. It describes the direct effect of the IV on the Outcome.
-   *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
-   *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. It's calculated by dividing the ACME through the total effect.

```{r}
# we want to be able to know which dataset our results are coming from
mediation_results_cat1_sedated_sum$cat<-1
mediation_results_cat1_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat1_sedated_sum),'(treated)',"" )
mediation_results_cat2_sedated_sum$cat<-2
mediation_results_cat2_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat2_sedated_sum),'(treated)',"" )
mediation_results_cat3_sedated_sum$cat<-3
mediation_results_cat3_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat3_sedated_sum),'(treated)',"" )
mediation_results_cat4_sedated_sum$cat<-4
mediation_results_cat4_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat4_sedated_sum),'(treated)',"" )
mediation_results_cat6_sedated_sum$cat<-6
mediation_results_cat6_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat6_sedated_sum),'(treated)',"" )
mediation_results_cat7_sedated_sum$cat<-7
mediation_results_cat7_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat7_sedated_sum),'(treated)',"" )
mediation_results_cat8_sedated_sum$cat<-8
mediation_results_cat8_sedated_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat8_sedated_sum),'(treated)',"" )
mediation_results_all_sedated<-rbind(
 mediation_results_cat1_sedated_sum
,mediation_results_cat2_sedated_sum
,mediation_results_cat3_sedated_sum
,mediation_results_cat4_sedated_sum
,mediation_results_cat6_sedated_sum
,mediation_results_cat7_sedated_sum
,mediation_results_cat8_sedated_sum
)

rownames(mediation_results_all_sedated)<-NULL

#add total effect (Odds ratio) to the table

total_effect_forplot_sedated<-rbind(total_effect_sedated,data.frame(cat = 5,estimated = 0,se = 0,p = NA))

total_effect_forplot_sedated<-total_effect_forplot_sedated%>%
  mutate(lb = estimated -1.96*se, 
         ub = estimated + 1.96*se,
         or = exp(estimated),
         or.lb = exp(lb),
         or.ub = exp(ub))

total_effect_forplot_sedated_copy<-total_effect_forplot_sedated%>%
  transmute(Estimate = or, 
            '95% CI Upper' = or.ub,
            '95% CI Lower' = or.lb,
            cat = cat,
            'p-value' = p,
            results = "Total Effect (OR)")

results_sedated<-rbind(mediation_results_all_sedated,total_effect_forplot_sedated_copy)
```

## Final subfigure: Prop. Mediated + Total Effect

```{r }
mediation_results_sedated_propmediated<-mediation_results_all_sedated%>%
  filter(results %in% c("Prop. Mediated (average)") ) %>%
  dplyr::select(Estimate,cat,results)

mediation_results_sedated_propmediated<-rbind(mediation_results_sedated_propmediated,
                                      data.frame(Estimate = 0, cat = 5, results = "Prop. Mediated (average)"))

spline_x <-spline(total_effect_forplot_sedated$cat, (total_effect_forplot_sedated$or - 1) * 100, n = 1000)$x
spline_hi <-spline(total_effect_forplot_sedated$cat, (total_effect_forplot_sedated$or.ub - 1) * 100, n = 1000)$y
spline_lo <-spline(total_effect_forplot_sedated$cat, (total_effect_forplot_sedated$or.lb - 1) * 100, n = 1000)$y

foo_ribbon <-data.frame(spline_x, spline_hi, spline_lo)

fig3c <- ggplot(data = mediation_results_sedated_propmediated, aes(x = cat, y = Estimate * 100)) +
  geom_bar(stat = 'identity', fill = "#3498db") +
  xlab('Baseline Sodium Category') +
  ylab('%') +
  geom_text(data = mediation_results_sedated_propmediated, aes(label = paste(round(Estimate * 100, 2), '%')), colour = "#2c3e50", vjust = 1.5) +
  scale_y_continuous(breaks = c(0, 50, 100)) +
  theme(legend.position = "bottom", plot.title.position = "plot", plot.caption.position =  "plot") +
  theme_minimal() +
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8),
                     labels = c("<120", "120- <125", "125- <130", "130- <135", "135- <140\n(Reference)", "140- <145", "145- <150", ">150")) +
  geom_point(data = total_effect_forplot_sedated, aes(x = cat, y = (or - 1) * 100), colour = "#c0392b") +
  geom_smooth(data = total_effect_forplot_sedated, aes(x = cat, y = (or - 1) * 100), method = "loess", span = 0.5, se = FALSE, colour = "#c0392b") +
  geom_ribbon(data = foo_ribbon, aes(x = spline_x, y = NULL, ymin = spline_lo, ymax = spline_hi),
              alpha = 0.4, inherit.aes = FALSE, width = 0.2, fill = '#e74c3c') +
  scale_y_continuous(position = "right", 
                     limits = c(-90, 245),
                     name = "Proportion of mortality mediated by GCS score",
                     sec.axis = sec_axis(~(. / 100) + 1, name = "Odds ratio (95%CI) of hospital mortality")) +  
labs(caption = "")
```
