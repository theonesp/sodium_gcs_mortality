---
title: "Sodium GCS Mediation Mortality"
author: Miguel Ángel Armengol de la Hoz
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mediation)
library(mgcv)
library(plotly)
library(voxel)
library(htmlwidgets)
library(readr)
library(bigrquery)
#bq_auth() # CRITICAL!!! THIS NEEDS TO BE RUN FROM THE CONSOLE. IT WON'T WORK IF RUN FROM MARKDOWN.
library(summarytools)
library(table1)
library(DBI)

winsorize_x = function(x, cut = 0.005){
  cut_point_top <- quantile(x, 1 - cut, na.rm = T)
  cut_point_bottom <- quantile(x, cut, na.rm = T)
  i = which(x >= cut_point_top) 
  x[i] = cut_point_top
  j = which(x <= cut_point_bottom) 
  x[j] = cut_point_bottom
  return(x)
}

'%!in%' <- function(x,y)!('%in%'(x,y))
impute.median <- function(x) replace(x, is.na(x), median(x, na.rm = TRUE))
```

# Data Load

## Set up BigQuery related functions

This chunks also creates the run_query and get_sql function.

```{r setup, include=FALSE}
# Configure connection 
con <- dbConnect(
  bigrquery::bigquery(),
  project = "hst-953-2018",
  #dataset = "samples",
  billing = "hst-953-2018"
)

# function for reading sql files
getSQL <- function(filepath){
  con = file(filepath, "r")
  sql.string <- ""

  while (TRUE){
    line <- readLines(con, n = 1)

    if ( length(line) == 0 ){
      break
    }

    line <- gsub("\\t", " ", line)

    if(grepl("--",line) == TRUE){
      line <- paste(sub("--","/*",line),"*/")
    }

    sql.string <- paste(sql.string, line)
  }

  close(con)
  return(sql.string)
}

```

## SQL Extraction

### Apache

The _apacheapsvar_ table contains the variables used to calculate the Acute Physiology Score (APS) III for patients. APS-III is an established method of summarizing patient severity of illness on admission to the ICU.

The score is part of the Acute Physiology Age Chronic Health Evaluation (APACHE) system of equations for predicting outcomes for ICU patients. See: http://eicu-crd.mit.edu/eicutables/apacheApsVar/

The _apachepredvar_ table provides variables underlying the APACHE predictions. Acute Physiology Age Chronic Health Evaluation (APACHE) consists of a groups of equations used for predicting outcomes in critically ill patients. See: http://eicu-crd.mit.edu/eicutables/apachePredVar/

We are extracting all variables needed to calculate apache except sodium.

```{r}
#bq_auth() # CRITICAL!!! THIS NEEDS TO BE RUN FROM THE CONSOLE. IT WON'T WORK IF RUN FROM MARKDOWN.
apacheapsvar <- dbGetQuery(con, getSQL("sql/apacheapsvar.sql" ))
apachepredvar <- dbGetQuery(con, getSQL("sql/apachepredvar.sql" ))
selected_columns<-names(apachepredvar[names(apachepredvar) %!in% names(apacheapsvar)])
selected_columns<-c('patientunitstayid',selected_columns)

allapachevars<-inner_join(apacheapsvar
                         ,apachepredvar[,selected_columns]
                        ,by='patientunitstayid')

# we are removing the following variables since we already have them
allapachevars$age<-NULL
allapachevars$gender<-NULL



# we are correcting the electivesurgery variable
allapachevars<-allapachevars%>%mutate(
  electivesurgery=as.integer(if_else(is.na(electivesurgery),'0',as.character(electivesurgery)))
  
)
apache_groups <- dbGetQuery(con, getSQL("sql/apache_groups.sql" ))

apache_groups<-apache_groups%>%
  mutate(
    AP_grp=case_when(
  # selecting only top 10 apache groups
  AP_grp %in% c("Other","Sepsis","CardiacArrest","CVA","RespMedOther","ACS","GIBleed","CHF","Trauma","PNA") ~ AP_grp,
  TRUE   ~ 'Other'
  )

)
```

### Other variables

```{r}
basic_demographics <- dbGetQuery(con, getSQL("sql/basic_demographics.sql" ))
basic_demographics<-basic_demographics%>%mutate(
  # we are simplifying the ethnicity category
  ethnicity=if_else(ethnicity=='Caucasian','Caucasian','Not Caucasian')
)

gcs_baseline <- dbGetQuery(con, getSQL("sql/gcs_baseline.sql" ))
admission_sodium <- dbGetQuery(con, getSQL("sql/admission_sodium.sql" ))
charlson_score <- dbGetQuery(con, getSQL("sql/charlson_score.sql" ))
ventilated_binary_first_day <- dbGetQuery(con, getSQL("sql/ventilated_binary_first_day.sql" ))

```

# Left Join

```{r}
initial_dataset<-Reduce(function(...) merge(..., all.x=TRUE), list(
   basic_demographics
  ,gcs_baseline
  ,admission_sodium
  ,charlson_score
  ,ventilated_binary_first_day
  ,apache_groups
  ,allapachevars
))
```


# Addresing variables distribution

## Selecting variables

Basic demographics included age, gender, and ethnicity.  
Ethnicity was self-reported as white, African American, Hispanic, Asian, Native American, Other, or Unknown.  *TODO correct in manuscript only two races*

Admission diagnoses were adjudicated by trained clinicians within the first 24 hours of ICU admission as part of the Apache scoring system(20), and were categorized into the ten most common clinical categories, including sepsis, myocardial infarction/angina, trauma, gastrointestinal bleed, arrhythmia, drug/alcohol complications, cerebrovascular accident, coronary artery bypass grafting, pneumonia, malignancy related, congestive heart failure, unknown and other. *TODO correct in manuscript new top 10 cats*

A history of metastatic disease, AIDS, liver disease, stroke, renal disease, diabetes, cancer, leukemia, lymphoma, myocardial infraction, congestive heart failure, peripheral vascular disease, transient ischemic attack, dementia, chronic obstructive pulmonary diseae, connective tissue diease, and peptic ulcer disease, as adjudicated in the Charlson comorbidity scoring system were used to describe preexisting illness burden, and included as separate variables(21).  

The source of admission (emergency department, floor, other hospital, direct admission, recovery unit/operating room and other), 

Unit type (medical, medical surgical, surgical, cardiac, cardiothoracic, and neurological) were included as categorical variables.  

Mechanical ventilation during the first 24 hours of care was included as binary variable.

```{r}
selected_df<-initial_dataset%>%select(
# initial demographics  
patientunitstayid,
age,
gender, 
ethnicity, 
hospitaladmitsource,
unittype, 
AP_grp,
# comorb
charlson_mets6,
charlson_aids6,
charlson_liver3,
charlson_stroke2,
charlson_renal2,
charlson_dm,
charlson_cancer2,
charlson_leukemia2,
charlson_lymphoma2,
charlson_mi1,
charlson_chf1,
charlson_pvd1,
charlson_tia1,
charlson_dementia1,
charlson_copd1,
charlson_ctd1,
charlson_pud1,
charlson_liver1,
charlson_age_score,
#others
mechvent_day01,
#main
sodium1,
gcs_baseline,
hosp_mortality
)

# factorizing variables
selected_df$gender<-as.factor(selected_df$gender)
selected_df$ethnicity<-as.factor(selected_df$ethnicity) 
selected_df$AP_grp<-as.factor(selected_df$AP_grp)
selected_df$unittype<-as.factor(selected_df$unittype)
selected_df$hospitaladmitsource<-as.factor(selected_df$hospitaladmitsource)
selected_df$mechvent_day01<-as.factor(selected_df$mechvent_day01)
selected_df$hosp_mortality<-as.factor(selected_df$hosp_mortality)
```

# Exclusion criteria

We are not excluding patients with a baseline sodium outside of our groups.

```{r}
cat('initial number of patients:',nrow(selected_df))
selected_df<- selected_df[complete.cases(selected_df),]
cat('\nfinal number of patients:',nrow(selected_df))
```

# Addressing basseline sodium outliers

```{r}
# Winsorizing outliers
selected_df$sodium1<-winsorize_x(selected_df$sodium1)

```

# New variables creation

## Normal GCS

```{r}
selected_df$normal_gcs<-as.factor(if_else(selected_df$gcs_baseline==15,1,0))
```


## Baseline Sodium categories

Categories per John criteria.

<120	120 - <125	125 - <130	130 - <135	135 - <140	140 - <145	145 - <150	≥150

```{r}
selected_df<-selected_df%>%mutate(
  sodium_cat = case_when(
    sodium1 <=120 ~ '1',
    between(sodium1,120,125) ~ '2',
    between(sodium1,125,130) ~ '3',
    between(sodium1,130,135) ~ '4',
    between(sodium1,135,140) ~ '5', # This is the reference dataset
    between(sodium1,140,145) ~ '6', # still normal
    between(sodium1,145,150) ~ '7',
    sodium1>= 150 ~ '8',
    
  )
)

selected_df$sodium_cat<-as.factor(selected_df$sodium_cat)
```

# Dataset Export

```{r}
saveRDS(selected_df,file=paste('sodium_gcs_mediation_',Sys.Date(),'.Rds'))
```


# Studying initial variables distribution

```{r}
par(mfrow=c(1,2))
for (i in 1:ncol( selected_df)) {
colname<-names( selected_df[i])  
ifelse( nrow(unique( selected_df[i]))<30  
        ,barplot(table( selected_df[i]),main=colname,xlab=colname)
        ,hist(as.numeric(unlist( selected_df[,i]))
        ,main = paste("Histogram of" ,colname),xlab=colname)
         )
cat('Summary of ',colname,'\n',sep = '')  
cat(summary( selected_df[i]),'\n',sep = '|')
}
```

# Table 1

## Stratified by mortality

```{r}
table1(~age+gender + normal_gcs + sodium_cat +ethnicity + unittype+ charlson_liver1 +charlson_chf1+mechvent_day01+AP_grp+ mechvent_day01 | hosp_mortality,data=selected_df )
```

## Stratified by sodium category

```{r}
table1(~hosp_mortality + normal_gcs + sodium_cat +apache_iv+age+gender+ethnicity+unittype+ charlson_liver1 +charlson_chf1+mechvent_day01+AP_grp+ mechvent_day01 | sodium_cat,data=selected_df )
```


# Separate Sodium bands datasets

## Creating the subsets

```{r}
sodium_split <- split( selected_df,  selected_df$sodium_cat)
```

## Storing every subset in a different dataset

```{r}
for (i in c(1:max(selected_df$sodium_cat))){ 
assign( paste('sodium_cat_',i,'_df',sep=''), sodium_split[[i]])
  }
```

## Creating the datasets for the analysis

I created 1 dataset per category that includes the category level and the reference level. I did this 7 times since category 5 is the reference and does not need a separate analysis.

I coded being on the reference as 0 and being on a different sodium category as 1.

```{r}
sodium_cat_1_df<-rbind(sodium_cat_1_df,sodium_cat_5_df)
sodium_cat_2_df<-rbind(sodium_cat_2_df,sodium_cat_5_df)
sodium_cat_3_df<-rbind(sodium_cat_3_df,sodium_cat_5_df)
sodium_cat_4_df<-rbind(sodium_cat_4_df,sodium_cat_5_df)
sodium_cat_6_df<-rbind(sodium_cat_6_df,sodium_cat_5_df)
sodium_cat_7_df<-rbind(sodium_cat_7_df,sodium_cat_5_df)
sodium_cat_8_df<-rbind(sodium_cat_8_df,sodium_cat_5_df)

sodium_cat_1_df<-sodium_cat_1_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_1')
)

sodium_cat_2_df<-sodium_cat_2_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_2')
)

sodium_cat_3_df<-sodium_cat_3_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_3')
)

sodium_cat_4_df<-sodium_cat_4_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_4')
)

sodium_cat_6_df<-sodium_cat_6_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_6')
)

sodium_cat_7_df<-sodium_cat_7_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_7')
)

sodium_cat_8_df<-sodium_cat_8_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_8')
)

```



