---
title: "Sodium GCS Mediation Mortality"
author: Miguel Ángel Armengol de la Hoz
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mediation)
library(mgcv)
library(plotly)
library(voxel)
library(htmlwidgets)
library(readr)
library(bigrquery)
library(summarytools)
winsorize_x = function(x, cut = 0.005){
  cut_point_top <- quantile(x, 1 - cut, na.rm = T)
  cut_point_bottom <- quantile(x, cut, na.rm = T)
  i = which(x >= cut_point_top) 
  x[i] = cut_point_top
  j = which(x <= cut_point_bottom) 
  x[j] = cut_point_bottom
  return(x)
}

'%!in%' <- function(x,y)!('%in%'(x,y))
impute.median <- function(x) replace(x, is.na(x), median(x, na.rm = TRUE))
```

# Data Load

## Set up BigQuery related functions

This chunks also creates the run_query and get_sql function.

```{r setup, include=FALSE}
# Updated for our year
project_id <- "hst-953-2018"
options(httr_oauth_cache=FALSE)
# Function that takes in a sql command and runs it on bigquery
run_query <- function(query){
  data <- query_exec(query, project=project_id, use_legacy_sql=FALSE,max_pages = Inf)
  return(data)
}

# function for reading sql files
getSQL <- function(filepath){
  con = file(filepath, "r")
  sql.string <- ""

  while (TRUE){
    line <- readLines(con, n = 1)

    if ( length(line) == 0 ){
      break
    }

    line <- gsub("\\t", " ", line)

    if(grepl("--",line) == TRUE){
      line <- paste(sub("--","/*",line),"*/")
    }

    sql.string <- paste(sql.string, line)
  }

  close(con)
  return(sql.string)
}

```

## SQL Extraction

### Apache

The _apacheapsvar_ table contains the variables used to calculate the Acute Physiology Score (APS) III for patients. APS-III is an established method of summarizing patient severity of illness on admission to the ICU.

The score is part of the Acute Physiology Age Chronic Health Evaluation (APACHE) system of equations for predicting outcomes for ICU patients. See: http://eicu-crd.mit.edu/eicutables/apacheApsVar/

The _apachepredvar_ table provides variables underlying the APACHE predictions. Acute Physiology Age Chronic Health Evaluation (APACHE) consists of a groups of equations used for predicting outcomes in critically ill patients. See: http://eicu-crd.mit.edu/eicutables/apachePredVar/

We are extracting all variables needed to calculate apache except sodium.

```{r}
apacheapsvar <- run_query(getSQL("sql/apacheapsvar.sql" ))
apachepredvar <- run_query(getSQL("sql/apachepredvar.sql" ))
selected_columns<-names(apachepredvar[names(apachepredvar) %!in% names(apacheapsvar)])
selected_columns<-c('patientunitstayid',selected_columns)

allapachevars<-inner_join(apacheapsvar
                         ,apachepredvar[,selected_columns]
                        ,by='patientunitstayid')

# we are removing the following variables since we already have them
allapachevars$admitdiagnosis<-NULL
allapachevars$age<-NULL
allapachevars$gender<-NULL


# we are correcting the following variable
allapachevars<-allapachevars%>%mutate(
  electivesurgery=if_else(is.na(electivesurgery),0,electivesurgery)
  
)

```

### Other variables

```{r}
basic_demographics <- run_query(getSQL("sql/basic_demographics.sql" ))
basic_demographics<-basic_demographics%>%mutate(
  ethnicity=if_else(ethnicity=='Caucasian','Caucasian','Not Caucasian')
)

gcs_baseline <- run_query(getSQL("sql/gcs_baseline.sql" ))
admission_sodium <- run_query(getSQL("sql/admission_sodium.sql" ))
charlson_score <- run_query(getSQL("sql/charlson_score.sql" ))
charlson_score<-charlson_score%>%select(patientunitstayid,charlson_liver1 ,charlson_chf1)
ventilated_binary_first_day <- run_query(getSQL("sql/ventilated_binary_first_day.sql" ))
apache_groups <- run_query(getSQL("sql/apache_groups.sql" ))

```

# Left Join

```{r}
initial_dataset<-Reduce(function(...) merge(..., all.x=TRUE), list(
   basic_demographics
  ,gcs_baseline
  ,admission_sodium
  ,charlson_score
  ,ventilated_binary_first_day
  ,apache_groups
  ,allapachevars
))
```


# Addresing variables distribution

## Selecting variables

Apache variables:

 intubated, vent, dialysis, eyes, motor, verbal, meds, urine, wbc, temperature, respiratoryrate, heartrate, meanbp, ph, hematocrit, creatinine, albumin, pao2, pco2, bun, glucose, bilirubin, fio2, sicuday, saps3day1, saps3today, saps3yesterday,  teachtype, region, bedcount, admitsource, graftcount,   thrombolytics, diedinhospital, aids, hepaticfailure, lymphoma, metastaticcancer, leukemia, immunosuppression, cirrhosis, electivesurgery, activetx, readmit, ima, midur, ventday1, oobventday1, oobintubday1, diabetes, managementsystem, var03hspxlos, ejectfx, dischargelocation, visitnumber, amilocation, day1meds, day1verbal, day1motor, day1eyes, day1pao2, day1fio2

```{r}
selected_df<-initial_dataset%>%select(
# initial demographics  
patientunitstayid,sodium1,gcs_baseline,apache_iv,age,gender,ethnicity,unittype, charlson_liver1 ,charlson_chf1,mechvent_day01,apachedxgroup,
hosp_mortality,
# apache related variables
intubated, vent, dialysis, eyes, motor, verbal, meds, urine, wbc, temperature, respiratoryrate, heartrate, meanbp, ph, hematocrit, creatinine, albumin, pao2, pco2, bun, glucose, bilirubin, fio2, sicuday, saps3day1, saps3today, saps3yesterday,  teachtype, region, bedcount, admitsource, graftcount,   thrombolytics, diedinhospital, aids, hepaticfailure, lymphoma, metastaticcancer, leukemia, immunosuppression, cirrhosis, electivesurgery, activetx, readmit, ima, midur, ventday1, oobventday1, oobintubday1, diabetes, managementsystem, var03hspxlos, ejectfx, dischargelocation, visitnumber, amilocation, day1meds, day1verbal, day1motor, day1eyes, day1pao2, day1fio2
                                      )

selected_df$gender<-as.factor(selected_df$gender)
```

# Exclusion criteria

We are not excluding patients with a baseline sodium outside of our groups.

```{r}
selected_df<- selected_df[complete.cases(selected_df),]
```

# Addressing basseline sodium outliers

```{r}
# Winsorizing outliers
selected_df$sodium1<-winsorize_x(selected_df$sodium1)

```

# New variables creation

## Normal GCS

```{r}
selected_df$normal_gcs<-if_else(selected_df$gcs_baseline==15,1,0)
```


## Baseline Sodium categories

Categories per John criteria.

<120	120 - <125	125 - <130	130 - <135	135 - <140	140 - <145	145 - <150	≥150

```{r}
selected_df<-selected_df%>%mutate(
  sodium_cat = case_when(
    sodium1 <=120 ~ '1',
    between(sodium1,120,125) ~ '2',
    between(sodium1,125,130) ~ '3',
    between(sodium1,130,135) ~ '4',
    between(sodium1,135,140) ~ '5', # This is the reference dataset
    between(sodium1,140,145) ~ '6',
    between(sodium1,145,150) ~ '7',
    sodium1>= 150 ~ '8',
    
  )
)
```

# Studying initial variables distribution

```{r}
par(mfrow=c(1,2))
for (i in 1:ncol( selected_df)) {
colname<-names( selected_df[i])  
ifelse( nrow(unique( selected_df[i]))<30  
        ,barplot(table( selected_df[i]),main=colname,xlab=colname)
        ,hist(as.numeric(unlist( selected_df[,i]))
        ,main = paste("Histogram of" ,colname),xlab=colname)
         )
cat('Summary of ',colname,'\n',sep = '')  
cat(summary( selected_df[i]),'\n',sep = '|')
}
```

# Separate Sodium bands datasets

## Creating the subsets

```{r}
sodium_split <- split( selected_df,  selected_df$sodium_cat)
```

## Storing every subset in a different dataset

```{r}
for (i in c(1:max(selected_df$sodium_cat))){ 
assign( paste('sodium_cat_',i,'_df',sep=''), sodium_split[[i]])
  }
```

## Creating the datasets for the analysis

I created 1 dataset per category that includes the category level and the reference level. I did this 7 times since category 5 is the reference and does not need a separate analysis.

I coded being on the reference as 0 and being on a different sodium category as 1.

```{r}
sodium_cat_1_df<-rbind(sodium_cat_1_df,sodium_cat_5_df)
sodium_cat_2_df<-rbind(sodium_cat_2_df,sodium_cat_5_df)
sodium_cat_3_df<-rbind(sodium_cat_3_df,sodium_cat_5_df)
sodium_cat_4_df<-rbind(sodium_cat_4_df,sodium_cat_5_df)
sodium_cat_6_df<-rbind(sodium_cat_6_df,sodium_cat_5_df)
sodium_cat_7_df<-rbind(sodium_cat_7_df,sodium_cat_5_df)
sodium_cat_8_df<-rbind(sodium_cat_8_df,sodium_cat_5_df)

sodium_cat_1_df<-sodium_cat_1_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_1')
)

sodium_cat_2_df<-sodium_cat_2_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_2')
)

sodium_cat_3_df<-sodium_cat_3_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_3')
)

sodium_cat_4_df<-sodium_cat_4_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_4')
)

sodium_cat_6_df<-sodium_cat_6_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_6')
)

sodium_cat_7_df<-sodium_cat_7_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_7')
)

sodium_cat_8_df<-sodium_cat_8_df%>%mutate(
  sodium_cat=if_else(sodium_cat==5,'0Ref','cat_8')
)

```



