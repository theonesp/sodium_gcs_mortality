---
title: "Mediation_DB_robust"
author: "Sicheng, Miguel"
date: "5/27/2020"
output: html_document
---

# Environment

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mediation)
library(mgcv)
library(plotly)
library(voxel)
library(htmlwidgets)
library(readr)
library(stringi)
library(mediation)
library(glmnet)
library(data.table)
'%!in%' <- function(x,y)!('%in%'(x,y))
extract_mediation_summary <- function (x) { 

  clp <- 100 * x$conf.level
  isLinear.y <- ((class(x$model.y)[1] %in% c("lm", "rq")) || 
                   (inherits(x$model.y, "glm") && x$model.y$family$family == 
                      "gaussian" && x$model.y$family$link == "identity") || 
                   (inherits(x$model.y, "survreg") && x$model.y$dist == 
                      "gaussian"))

  printone <- !x$INT && isLinear.y

  if (printone) {

    smat <- c(x$d1, x$d1.ci, x$d1.p)
    smat <- rbind(smat, c(x$z0, x$z0.ci, x$z0.p))
    smat <- rbind(smat, c(x$tau.coef, x$tau.ci, x$tau.p))
    smat <- rbind(smat, c(x$n0, x$n0.ci, x$n0.p))

    rownames(smat) <- c("ACME", "ADE", "Total Effect", "Prop. Mediated")

  } else {
    smat <- c(x$d0, x$d0.ci, x$d0.p)
    smat <- rbind(smat, c(x$d1, x$d1.ci, x$d1.p))
    smat <- rbind(smat, c(x$z0, x$z0.ci, x$z0.p))
    smat <- rbind(smat, c(x$z1, x$z1.ci, x$z1.p))
    smat <- rbind(smat, c(x$tau.coef, x$tau.ci, x$tau.p))
    smat <- rbind(smat, c(x$n0, x$n0.ci, x$n0.p))
    smat <- rbind(smat, c(x$n1, x$n1.ci, x$n1.p))
    smat <- rbind(smat, c(x$d.avg, x$d.avg.ci, x$d.avg.p))
    smat <- rbind(smat, c(x$z.avg, x$z.avg.ci, x$z.avg.p))
    smat <- rbind(smat, c(x$n.avg, x$n.avg.ci, x$n.avg.p))

    rownames(smat) <- c("ACME (control)", "ACME (treated)", 
                        "ADE (control)", "ADE (treated)", "Total Effect", 
                        "Prop. Mediated (control)", "Prop. Mediated (treated)", 
                        "ACME (average)", "ADE (average)", "Prop. Mediated (average)")

  }

  colnames(smat) <- c("Estimate", paste(clp, "% CI Lower", sep = ""), 
                      paste(clp, "% CI Upper", sep = ""), "p-value")
  smat

}

sodium_cat_1_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality/data/g1.csv")
sodium_cat_2_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g2.csv")
sodium_cat_3_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g3.csv")
sodium_cat_4_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g4.csv")
sodium_cat_5_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g5.csv")
sodium_cat_6_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g6.csv")
sodium_cat_7_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g7.csv")
sodium_cat_8_df<-fread("/Users/sichenghao/Documents/GitHub/sodium_gcs_mortality//data/g8.csv")
```

# Mediation package

 - *ACME:*  Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
 - *ADE:*  Average direct effects. It describes the direct effect of the IV on the Outcome.
 - *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
 - *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. Itâ€™s calculated by dividing the ACME through the total effect.



## Mediation analysis: Baseline sodium_cat_1

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_1_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_1_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_1_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_1_df$w <- 1 / p

summary(sodium_cat_1_df$w)


sodium_cat_1_0<-sodium_cat_1_df%>%filter(sodium_cat==0)
sodium_cat_1_1<-sodium_cat_1_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_1_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_1_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_1_0$wm <- 1 / p

summary(sodium_cat_1_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_1_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_1_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_1_1$wm <- 1 / p

summary(sodium_cat_1_1$wm)

sodium_cat_1_df<-rbind(sodium_cat_1_0,sodium_cat_1_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_1_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_1_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_1_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat1 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat1_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat1))
mediation_results_cat1_sum

mediation_results_cat1_sum<-mediation_results_cat1_sum[grepl("treated|Total Effect", rownames(mediation_results_cat1_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_2

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_2_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_2_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_2_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_2_df$w <- 1 / p

summary(sodium_cat_2_df$w)


sodium_cat_2_0<-sodium_cat_2_df%>%filter(sodium_cat==0)
sodium_cat_2_1<-sodium_cat_2_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_2_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_2_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_2_0$wm <- 1 / p

summary(sodium_cat_2_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_2_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_2_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_2_1$wm <- 1 / p

summary(sodium_cat_2_1$wm)

sodium_cat_2_df<-rbind(sodium_cat_2_0,sodium_cat_2_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_2_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_2_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_2_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat2 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat2_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat2))
mediation_results_cat2_sum

mediation_results_cat2_sum<-mediation_results_cat2_sum[grepl("treated|Total Effect", rownames(mediation_results_cat2_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_3

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_3_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_3_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_3_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_3_df$w <- 1 / p

summary(sodium_cat_3_df$w)


sodium_cat_3_0<-sodium_cat_3_df%>%filter(sodium_cat==0)
sodium_cat_3_1<-sodium_cat_3_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_3_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_3_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_3_0$wm <- 1 / p

summary(sodium_cat_3_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_3_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_3_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_3_1$wm <- 1 / p

summary(sodium_cat_3_1$wm)

sodium_cat_3_df<-rbind(sodium_cat_3_0,sodium_cat_3_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_3_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_3_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_3_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat3 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat3_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat3))
mediation_results_cat3_sum

mediation_results_cat3_sum<-mediation_results_cat3_sum[grepl("treated|Total Effect", rownames(mediation_results_cat3_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_4

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_4_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_4_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_4_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_4_df$w <- 1 / p

summary(sodium_cat_4_df$w)


sodium_cat_4_0<-sodium_cat_4_df%>%filter(sodium_cat==0)
sodium_cat_4_1<-sodium_cat_4_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_4_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_4_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_4_0$wm <- 1 / p

summary(sodium_cat_4_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_4_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_4_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_4_1$wm <- 1 / p

summary(sodium_cat_4_1$wm)

sodium_cat_4_df<-rbind(sodium_cat_4_0,sodium_cat_4_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_4_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_4_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_4_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat4 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat4_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat4))
mediation_results_cat4_sum

mediation_results_cat4_sum<-mediation_results_cat4_sum[grepl("treated|Total Effect", rownames(mediation_results_cat4_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_6

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_6_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_6_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_6_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_6_df$w <- 1 / p

summary(sodium_cat_6_df$w)


sodium_cat_6_0<-sodium_cat_6_df%>%filter(sodium_cat==0)
sodium_cat_6_1<-sodium_cat_6_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_6_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_6_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_6_0$wm <- 1 / p

summary(sodium_cat_6_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_6_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_6_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_6_1$wm <- 1 / p

summary(sodium_cat_6_1$wm)

sodium_cat_6_df<-rbind(sodium_cat_6_0,sodium_cat_6_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_6_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_6_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_6_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat6 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat6_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat6))
mediation_results_cat6_sum

mediation_results_cat6_sum<-mediation_results_cat6_sum[grepl("treated|Total Effect", rownames(mediation_results_cat6_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_7

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_7_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_7_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_7_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_7_df$w <- 1 / p

summary(sodium_cat_7_df$w)


sodium_cat_7_0<-sodium_cat_7_df%>%filter(sodium_cat==0)
sodium_cat_7_1<-sodium_cat_7_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_7_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_7_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_7_0$wm <- 1 / p

summary(sodium_cat_7_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_7_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_7_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_7_1$wm <- 1 / p

summary(sodium_cat_7_1$wm)

sodium_cat_7_df<-rbind(sodium_cat_7_0,sodium_cat_7_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_7_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_7_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_7_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat7 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat7_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat7))
mediation_results_cat7_sum

mediation_results_cat7_sum<-mediation_results_cat7_sum[grepl("treated|Total Effect", rownames(mediation_results_cat7_sum)), ]
```
## Mediation analysis: Baseline sodium_cat_8

```{r,echo=FALSE}
#doubly robust mediation
prop.fit<-glm(sodium_cat ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_8_df,
              family = "binomial")
summary(prop.fit)

res<-predict(prop.fit, type = "response")

p <-
  ifelse(sodium_cat_8_df$sodium_cat == 0,
         1 - predict(prop.fit, type = "response"),
         predict(prop.fit, type = "response"))

p[p<0.05]=0.05#limit the weight
prop.score<-data.frame(res,p,sodium_cat = sodium_cat_8_df$sodium_cat)

ggplot(data = prop.score)+geom_histogram(aes(x = 1/p))+facet_wrap(~sodium_cat)
sodium_cat_8_df$w <- 1 / p

summary(sodium_cat_8_df$w)


sodium_cat_8_0<-sodium_cat_8_df%>%filter(sodium_cat==0)
sodium_cat_8_1<-sodium_cat_8_df%>%filter(sodium_cat==1)

prop.fit0<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_8_0,
              family = "binomial")
summary(prop.fit0)

res<-predict(prop.fit0, type = "response")

p <-
  ifelse(sodium_cat_8_0$normal_gcs == 0,
         1 - predict(prop.fit0, type = "response"),
         predict(prop.fit0, type = "response"))

p[p<0.05]=0.05
summary(p)
sodium_cat_8_0$wm <- 1 / p

summary(sodium_cat_8_0$wm)

prop.fit1<-glm(normal_gcs ~ age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
              data = sodium_cat_8_1,
              family = "binomial")
summary(prop.fit1)

res<-predict(prop.fit1, type = "response")

p <-
  ifelse(sodium_cat_8_1$normal_gcs == 0,
         1 - predict(prop.fit1, type = "response"),
         predict(prop.fit1, type = "response"))

p[p<0.05]=0.05

sodium_cat_8_1$wm <- 1 / p

summary(sodium_cat_8_1$wm)

sodium_cat_8_df<-rbind(sodium_cat_8_0,sodium_cat_8_1)


fit_totaleffect<-glm(as.factor(hosp_mortality)~ 
sodium_cat +                       
age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
# apache related variables
                   , sodium_cat_8_df
,family = binomial("probit"),weights = w*wm)
summary(fit_totaleffect)

fit_mediator<-glm(normal_gcs ~ sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2,
family = "binomial",
data =  sodium_cat_8_df,weights = w*wm)

fit_dv<-glm(as.factor(hosp_mortality) ~normal_gcs+sodium_cat+age+gender+ethnicity+unittype+charlson_liver1 +charlson_chf1+mechvent_day01+dialysis+urine+wbc+temperature+respiratoryrate+heartrate+meanbp+ ph+hematocrit+creatinine+albumin+albumin+pco2+bun+glucose+bilirubin+day1meds+day1pao2+day1fio2
                   , sodium_cat_8_df
           ,family = binomial("probit"),weights = w*wm)
summary(fit_dv)

#treat is the independend variable
mediation_results_cat8 <- mediate(fit_mediator, fit_dv, treat="sodium_cat", mediator="normal_gcs",sims = 200)

mediation_results_cat8_sum<-as.data.frame(extract_mediation_summary(mediation_results_cat8))
mediation_results_cat8_sum

mediation_results_cat8_sum<-mediation_results_cat8_sum[grepl("treated|Total Effect", rownames(mediation_results_cat8_sum)), ]
```


# Ploting results

## Appending results

 - *ACME:*  Average Causal Mediation Effects. This is the indirect effect of the IV on the outcome that goes through the mediator.
 - *ADE:*  Average direct effects. It describes the direct effect of the IV on the Outcome.
 - *Total Effect* the Total Effect (direct + indirect) of the IV on the Outcome.
 - *Prop. Mediated* describes the proportion of the effect of the IV on the Outcome that goes through the mediator. Itâ€™s calculated by dividing the ACME through the total effect.

```{r}
# we want to be able to know which dataset our results are coming from
mediation_results_cat1_sum$cat<-1
mediation_results_cat1_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat1_sum),'(treated)',"" )
mediation_results_cat2_sum$cat<-2
mediation_results_cat2_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat2_sum),'(treated)',"" )
mediation_results_cat3_sum$cat<-3
mediation_results_cat3_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat3_sum),'(treated)',"" )
mediation_results_cat4_sum$cat<-4
mediation_results_cat4_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat4_sum),'(treated)',"" )
mediation_results_cat6_sum$cat<-6
mediation_results_cat6_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat6_sum),'(treated)',"" )
mediation_results_cat7_sum$cat<-7
mediation_results_cat7_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat7_sum),'(treated)',"" )
mediation_results_cat8_sum$cat<-8
mediation_results_cat8_sum$results<-stri_replace_all_fixed(rownames(mediation_results_cat8_sum),'(treated)',"" )


mediation_results_all<-rbind(
 mediation_results_cat1_sum
,mediation_results_cat2_sum
,mediation_results_cat3_sum
,mediation_results_cat4_sum
,mediation_results_cat6_sum
,mediation_results_cat7_sum
,mediation_results_cat8_sum
)
rownames(mediation_results_all)<-NULL
```

## Final Plot


#Prop. Mediated

```{r}
mediation_results_filtered<-mediation_results_all%>% filter(results %in% c('Prop. Mediated '))

ggplot(data=mediation_results_filtered,aes(x=cat,y=Estimate,colour=results,fill=results))+
    geom_point()+
    geom_line()+
    geom_errorbar(data=mediation_results_filtered
                  ,aes(x=cat,ymin=`95% CI Lower`,ymax=`95% CI Upper`,fill=results)
                  ,alpha=0.3
                  ,inherit.aes=FALSE
                  ,width=0.2)+
    xlab('Baseline Sodium Category')+
    ylab('Estimate')+
    #scale_color_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #scale_fill_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #labs(colour='sex', fill='sex') +
    theme_minimal()+
  ggtitle('Proportion Mediated')+
  scale_x_continuous(breaks = c(1,2,3,4,6,7,8))
```

### Indirect Effect

```{r}
mediation_results_filtered<-mediation_results_all%>% filter(results %in% c('ACME '))

ggplot(data=mediation_results_filtered,aes(x=cat,y=Estimate,colour=results,fill=results))+
    geom_point()+
    geom_line()+
    geom_errorbar(data=mediation_results_filtered
                  ,aes(x=cat,ymin=`95% CI Lower`,ymax=`95% CI Upper`,fill=results)
                  ,alpha=0.3
                  ,inherit.aes=FALSE
                  ,width=0.2)+
    xlab('Baseline Sodium Category')+
    ylab('Estimate')+
    #scale_color_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #scale_fill_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #labs(colour='sex', fill='sex') +
    theme_minimal()+
  ggtitle('ACME\nAverage Causal Mediation Effects\nIndirect effect of Sodium on mortality that goes through the mediator (GCS)')+
  scale_x_continuous(breaks = c(1,2,3,4,6,7,8))
```


#Direct Effect

```{r}
mediation_results_filtered<-mediation_results_all%>% filter(results %in% c('ADE '))

ggplot(data=mediation_results_filtered,aes(x=cat,y=Estimate,colour=results,fill=results))+
    geom_point()+
    geom_line()+
    geom_errorbar(data=mediation_results_filtered
                  ,aes(x=cat,ymin=`95% CI Lower`,ymax=`95% CI Upper`,fill=results)
                  ,alpha=0.3
                  ,inherit.aes=FALSE
                  ,width=0.2)+
    xlab('Baseline Sodium Category')+
    ylab('Estimate')+
    #scale_color_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #scale_fill_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #labs(colour='sex', fill='sex') +
    theme_minimal()+
  ggtitle("Average Direct Effect")+
  scale_x_continuous(breaks = c(1,2,3,4,6,7,8))
```
#Total Effect

```{r}
mediation_results_filtered<-mediation_results_all%>% filter(results %in% c('Total Effect'))

ggplot(data=mediation_results_filtered,aes(x=cat,y=Estimate,colour=results,fill=results))+
    geom_point()+
    geom_line()+
    geom_errorbar(data=mediation_results_filtered
                  ,aes(x=cat,ymin=`95% CI Lower`,ymax=`95% CI Upper`,fill=results)
                  ,alpha=0.3
                  ,inherit.aes=FALSE
                  ,width=0.2)+
    xlab('Baseline Sodium Category')+
    ylab('Estimate')+
    #scale_color_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #scale_fill_manual(labels = c("Male", "Female"), values = c("#1abc9c","#f1c40f"))+
    #labs(colour='sex', fill='sex') +
    theme_minimal()+
  ggtitle('Total Effect')+
  scale_x_continuous(breaks = c(1,2,3,4,6,7,8))
```

